
下面是面向“用户与校区独立微服务”的 **NestJS + TypeScript** 架构文档（说明–原理–讲解），包含：项目名称、技术栈与环境、功能点、数据库设计、API 参数与输出、技术方案（含性能与备份、审计与Redis）。按你的需求覆盖用户、校区与薪资（区间法）全链路，**不含任何代码**。

---

## 1. 项目名称

EduHub Microservices – User & Campus Domain (with Compensation & Payroll)

---

## 2. 框架技术，语言，环境

* 语言/运行时：TypeScript、Node.js 20 LTS（NestJS 10，底层首选 Fastify 以获得更高 QPS）
* 架构范式：微服务 + DDD（领域拆分：user-service、campus-service、payroll-service）
* 通信协议：

  * 公网/网关：HTTP/REST（OpenAPI 3 规范）
  * 内部：gRPC 或消息总线（事件：NATS / Kafka 二选一）
* 数据存储：MySQL 8.0（每个服务**独立数据库**，无跨库外键）、对象存储（身份证电子版文件以 URL/Key 引用）
* 缓存与队列：Redis 7（缓存、分布式锁、限流、会话、延时任务/队列）
* 部署与运维：Docker / Kubernetes、Prometheus + Grafana、ELK/EFK、OpenTelemetry
* 时区与本地化：Asia/Taipei，ISO-8601 日期时间

---

## 3. 功能点

* 用户域（user-service）

  * 用户主数据（增删改查、筛选、状态流转、校区归属、角色关联）
  * 身份证电子版元数据管理（仅保存受控 URL/Key）
  * 审计：用户信息变更留痕
* 校区域（campus-service）

  * 校区主数据（多租户 org 维度）
  * 校区账户/开票资料、教室管理
  * 负责人指派（引用用户ID，服务间校验）
  * 审计：校区与教室变更留痕
* 薪资与发薪（payroll-service）

  * 薪资标准“区间法”管理（\[valid\_from, valid\_to)）
  * 防区间重叠校验、自动闭合上一区间
  * 任意日期点查有效薪资；月度应发按日折算；批量生成当月快照
  * 审计：薪资标准与发薪确认留痕
* 平台级能力

  * Redis 缓存/锁/限流；API 网关鉴权与配额；幂等与请求跟踪
  * 备份与恢复（全量+增量/日志，异地冗余）
  * 多租户隔离与 RBAC、敏感字段脱敏/加密

---

## 4. 数据库设计（MySQL 8，**按服务独立库**，示意字段与约束；不写DDL）

### 4.1 user-service（用户域数据库）

**表：user**

* user\_id (PK, bigint)
* org\_id (bigint, 逻辑多租户)
* campus\_id (bigint，引用 campus-service 的主键值，仅存ID不做跨库外键)
* username (varchar, 唯一)
* employment\_status (enum: 在职/离职/停薪留职)
* hire\_date (date)
* email (varchar, 唯一)
* phone (varchar, 唯一)
* id\_card\_no (varchar, 唯一，敏感)
* id\_card\_file (varchar, 存储URL/Key，敏感)
* education (enum: 小学/初中/高中/中专/大专/本科/硕士/博士/其他)
* hukou\_address (varchar)
* current\_address (varchar)
* gender (enum: 男/女/其他/未透露)
* role (varchar，轻量角色，建议与 RBAC 关联表并存)
* age (tinyint, 可冗余；建议另有 birthdate)
* created\_at / updated\_at (timestamp)

索引与约束（示例）

* 唯一：username, email, phone, id\_card\_no
* 组合：org\_id + campus\_id、employment\_status + campus\_id
* 脱敏视图（应用层或只读接口层实现）

**表：role**（可选，推荐）

* role\_id (PK), code (唯一), name

**表：user\_role**（多对多）

* user\_id + role\_id (PK)

**表：audit\_log**（或统一到 change\_log）

* id (PK), org\_id, actor\_user\_id, entity\_type('user'), entity\_id, action(create/update/delete), diff\_json, created\_at, request\_id

---

### 4.2 campus-service（校区域数据库）

**表：org**

* org\_id (PK), name (唯一), code (唯一), remark, created\_at, updated\_at

**表：tax\_profile**

* tax\_profile\_id (PK), name(唯一), rate(decimal%), is\_tax\_included(boolean), created\_at, updated\_at

**表：campus**

* campus\_id (PK)
* org\_id (FK 逻辑)
* name (varchar)
* code (varchar, 唯一)
* type (enum: 直营/加盟/合作)
* status (enum: 筹备/试运营/营业/停业/关闭)
* province / city / district (varchar)
* address (varchar)
* latitude / longitude (decimal)
* principal\_user\_id (bigint，引用 user 的ID，应用层/事件校验)
* phone / email (varchar)
* biz\_hours (json)
* open\_date / close\_date (date)
* area (decimal), capacity (int)
* trade\_area\_tags (json)
* remark (text)
* created\_at / updated\_at (timestamp)

索引

* 唯一：code
* 组合：org\_id + status、org\_id + name

**表：campus\_billing\_profile**

* id (PK)
* campus\_id (bigint)
* invoice\_title / tax\_no (varchar)
* bank\_name / bank\_account (varchar)
* invoice\_address / phone (varchar)
* tax\_profile\_id (bigint)
* created\_at / updated\_at

索引

* campus\_id、tax\_profile\_id

**表：classroom**

* classroom\_id (PK)
* campus\_id (bigint)
* name (varchar)
* code (varchar, 唯一)
* capacity (int)
* course\_type\_tags (json)
* status (enum: 可用/维护/停用)
* created\_at / updated\_at

索引

* 唯一：code
* 组合：campus\_id + status

**表：audit\_log / change\_log**（同规范）

---

### 4.3 payroll-service（薪资与发薪数据库）

**表：user\_compensation**（区间法，核心）

* comp\_id (PK)
* org\_id, user\_id (bigint)
* base\_salary (decimal(12,2))
* perf\_salary (decimal(12,2))
* valid\_from (date, 含)
* valid\_to (date, 不含，可空=至今)
* reason (varchar)
* created\_by (bigint), created\_at (timestamp)

索引与约束

* 唯一：user\_id + valid\_from
* 范围：user\_id + valid\_from + valid\_to（支持点查与月度相交查询）
* 应用层/触发器：同一 user 区间不得重叠

**表：payroll\_run**（发薪快照）

* run\_id (PK)
* org\_id, user\_id (bigint)
* payroll\_month (date，月初)
* period\_start / period\_end (date)
* days\_in\_month (int), days\_covered (int)
* base\_amount / perf\_amount / allowances / deductions (decimal)
* gross\_amount / tax\_amount / net\_amount (decimal)
* status (enum: draft/confirmed/paid)
* snapshot\_json (json)
* created\_at (timestamp)

索引

* 唯一：payroll\_month + user\_id
* 组合：user\_id + payroll\_month

**表：change\_log**（全域通用，建议单独库或平台库）

* id (PK), org\_id
* entity\_type (user/campus/user\_compensation/payroll\_run…)
* entity\_id (bigint)
* field\_name (varchar)
* old\_value (text), new\_value (text)
* changed\_by (bigint), changed\_at (timestamp)
* change\_reason (text), ip\_address, device\_info
* request\_id / trace\_id

---

## 5. API 接口参数和输出（按服务分组；只列**参数与JSON结构**，不含代码）

### 5.1 user-service（路径前缀：/api/users）

通用请求头

* Authorization: Bearer <token>
* X-Request-Id: <uuid>（幂等）
* X-Org-Id: \<org\_id>（多租户）
* X-Campus-Id: \<campus\_id>（可选）

1）创建用户 `POST /`
请求体

```
{
  "org_id": 1,
  "campus_id": 101,
  "username": "zhangsan",
  "employment_status": "在职",
  "hire_date": "2025-08-01",
  "email": "zhangsan@example.com",
  "phone": "+886-912345678",
  "id_card_no": "110101199001011234",
  "id_card_file": "s3://bucket/path/to/idcard.pdf",
  "education": "本科",
  "hukou_address": "北京...",
  "current_address": "北京...",
  "gender": "男",
  "role": "teacher",
  "age": 29
}
```

响应体

```
{
  "user_id": 2001,
  "created_at": "2025-08-16T03:12:00Z"
}
```

2）查询用户 `GET /{user_id}`
响应体

```
{
  "user_id": 2001,
  "org_id": 1,
  "campus_id": 101,
  "username": "zhangsan",
  "employment_status": "在职",
  "hire_date": "2025-08-01",
  "email": "zhangsan@example.com",
  "phone": "+886-912345678",
  "id_card_no": "1101**********1234",
  "id_card_file": "signed-url-or-key",
  "education": "本科",
  "hukou_address": "北京...",
  "current_address": "北京...",
  "gender": "男",
  "roles": ["teacher"],
  "age": 29,
  "created_at": "2025-08-16T03:12:00Z",
  "updated_at": "2025-08-16T03:12:00Z"
}
```

3）分页列表 `GET /?q=&status=&campus_id=&page_size=&cursor=`
响应体

```
{
  "items": [ { ...user summary... } ],
  "next_cursor": "eyJwYWdlIjoyfQ==",
  "total": 1240
}
```

4）更新用户 `PATCH /{user_id}`
请求体（部分字段）

```
{
  "employment_status": "停薪留职",
  "email": "new@example.com",
  "campus_id": 102,
  "role": "finance",
  "change_reason": "内部轮岗"
}
```

响应体

```
{ "updated": true, "updated_at": "2025-08-16T04:10:00Z" }
```

5）删除/停用 `DELETE /{user_id}`
响应体

```
{ "deleted": true }
```

6）审计查询 `GET /{user_id}/changes?from=&to=&page_size=&cursor=`
响应体

```
{
  "items": [
    {
      "changed_at": "2025-08-16T04:10:00Z",
      "changed_by": 9001,
      "field_name": "employment_status",
      "old_value": "在职",
      "new_value": "停薪留职",
      "reason": "内部轮岗",
      "request_id": "..."
    }
  ],
  "next_cursor": null
}
```

---

### 5.2 campus-service（路径前缀：/api/campuses）

1）创建校区 `POST /`
请求体

```
{
  "org_id": 1,
  "name": "海淀校区",
  "code": "HAIDIAN-01",
  "type": "直营",
  "status": "营业",
  "province": "北京",
  "city": "北京",
  "district": "海淀",
  "address": "中关村...",
  "latitude": 39.98,
  "longitude": 116.31,
  "principal_user_id": 2001,
  "phone": "010-12345678",
  "email": "campus@xx.com",
  "biz_hours": {"mon-fri":"09:00-20:00","sat-sun":"09:00-18:00"},
  "open_date": "2024-09-01",
  "area": 350.50,
  "capacity": 120,
  "trade_area_tags": ["地铁10号线","商圈A"],
  "remark": "重点校区"
}
```

响应体

```
{ "campus_id": 101, "created_at": "2025-08-16T03:30:00Z" }
```

2）查询/更新/列表（同用户风格）

3）开票资料 `POST /{campus_id}/billing-profiles`
请求体

```
{
  "invoice_title": "北京某某文化有限公司",
  "tax_no": "9111XXXXXXXXXXXX",
  "bank_name": "中国银行",
  "bank_account": "1234567890",
  "invoice_address": "北京...",
  "phone": "010-88888888",
  "tax_profile_id": 10
}
```

响应体

```
{ "id": 501, "created_at": "2025-08-16T03:40:00Z" }
```

4）教室 `POST /{campus_id}/classrooms`
请求体

```
{
  "name": "A101",
  "code": "A101",
  "capacity": 20,
  "course_type_tags": ["素描","油画"],
  "status": "可用"
}
```

响应体

```
{ "classroom_id": 3001 }
```

5）校区审计 `GET /{campus_id}/changes?from=&to=`

---

### 5.3 payroll-service（路径前缀：/api/payroll）

1）设置薪资标准（自动闭合上一条） `POST /compensations`
请求体

```
{
  "org_id": 1,
  "user_id": 2001,
  "base_salary": 9000.00,
  "perf_salary": 2500.00,
  "valid_from": "2025-07-01",
  "reason": "转正",
  "operator_id": 9001
}
```

响应体

```
{ "comp_id": 70001, "created_at": "2025-08-16T04:00:00Z" }
```

2）查询某日有效薪资 `GET /compensations/effective?user_id=&date=`
响应体

```
{
  "user_id": 2001,
  "date": "2025-07-15",
  "base_salary": 9000.00,
  "perf_salary": 2500.00,
  "source_comp_id": 70001
}
```

3）区间列表 `GET /compensations?user_id=&from=&to=&page_size=&cursor=`

4）计算单人某月应发（不落库） `GET /runs/preview?user_id=&month=2025-07-01`
响应体

```
{
  "user_id": 2001,
  "month": "2025-07-01",
  "days_in_month": 31,
  "days_covered": 31,
  "base_amount": 8854.84,
  "perf_amount": 2467.74
}
```

5）生成当月快照（单人）`POST /runs/generate`
请求体

```
{
  "org_id": 1,
  "user_id": 2001,
  "month": "2025-07-01",
  "allowances": 0,
  "deductions": 0
}
```

响应体

```
{ "run_id": 81001, "status": "draft" }
```

6）批量生成当月快照（在职）`POST /runs/generate-batch`
请求体

```
{ "org_id": 1, "month": "2025-07-01", "filter": { "campus_ids": [101,102] } }
```

响应体

```
{ "submitted": true, "batch_id": "run-2025-07-org1", "estimated": 234 }
```

7）确认或支付 `PATCH /runs/{run_id}`
请求体

```
{ "action": "confirm" }
```

响应体

```
{ "run_id": 81001, "status": "confirmed" }
```

8）发薪审计 `GET /runs/{run_id}/changes`

---

### 5.4 通用错误与分页

错误响应

```
{
  "error": {
    "code": "VALIDATION_ERROR",
    "message": "phone already exists",
    "details": {"field": "phone"},
    "request_id": "..."
  }
}
```

分页（游标）

```
{
  "items": [ ... ],
  "next_cursor": "base64-opaque",
  "total": 1234
}
```

---

## 6. 技术方案（原理与性能要点）

### 6.1 领域与边界

* **user-service** 独占用户主数据与角色；不对外暴露 PII 原始值（身份证号、文件URL仅在授权后返回带签名的短时效链接或做掩码）。
* **campus-service** 独占校区与教室；对 `principal_user_id` 仅存**外部ID**，通过内部 gRPC/事件与 user-service 校验一致性（**应用级外键**）。
* **payroll-service** 独占薪资与发薪；基于“区间法”高效点查与月度计算；产出**不可变快照**。

### 6.2 数据一致性与事件

* **Outbox + 事件总线**：每次主数据变更写入本地 outbox 并可靠投递（用户创建/更新、校区负责人变更、薪资标准变更、快照确认等）。
* **最终一致**：跨域引用采用**异步校验/补偿**（SAGA / 反查/回滚）。

### 6.3 Redis 接入角色

* **缓存**：用户概要、校区基础信息、薪资“某日有效值”与“月度计算结果”缓存（TTL 15–30 分钟；快照确认后可延长）。
* **分布式锁**：以 `lock:compensation:user:{user_id}` 防止并发写入导致区间重叠；批量发薪 `lock:payroll:month:{org_id}:{month}`。
* **限流与幂等**：请求级 Token 桶（/generate-batch）、`X-Request-Id` 去重。
* **队列**：批量发薪生成、审计落库、缓存失效等异步任务（Redis Streams/List 或接入专用 MQ）。

### 6.4 性能与可扩展

* **Fastify + Keep-Alive + HTTP压缩**；启用连接池复用。
* **读写分离**：MySQL 主写从读；报表/批量计算走只读副本。
* **索引策略**：

  * user：username/email/phone/id\_card\_no 唯一，(org\_id,campus\_id,status) 组合
  * campus：code 唯一，(org\_id,status)
  * compensation： (user\_id, valid\_from, valid\_to) 范围索引覆盖金额列
  * payroll\_run： (payroll\_month,user\_id) 唯一
* **批量计算优化**：月度计算按“相交区间”聚合，避免逐日迭代；对热门月份结果物化至 Redis。
* **分页**：游标分页优先，减少深翻页代价。
* **灰度与回滚**：配置开关控制新规则启用；事件消费实现幂等与重试。

### 6.5 安全与合规

* **RBAC**：平台级角色 + 资源范围（org/campus 维度）。薪资与身份证仅 HR/财务可见。
* **PII**：身份证号存加密或哈希，接口默认返回掩码；身份证文件只返回短时签名URL（或仅返回 Key 需再换签）。
* **传输与存储**：TLS；数据库磁盘加密；对象存储 KMS。
* **审计**：统一 change\_log；关键动作（作废、确认、支付）二次确认 + 审批链（可留扩展字段）。

### 6.6 备份与恢复（全域）

* **策略（Asia/Taipei）**

  * 日全量：每日 03:00
  * 增量/日志（binlog/WAL）：每 5–15 分钟
  * 保留：binlog 14 天；日全量 14 天；周全量 8 周；月全量 12 个月
  * 关键操作（DDL/大批导入/结算）：前后各一次快照
  * 异地副本 + 3-2-1 法则
* **演练**：季度 PITR 恢复演习；快照校验（checksum + 试恢复）
* **文件对象**：对象存储启用版本化与生命周期（≥90天转低频/归档）

### 6.7 可观测性与运维

* 健康检查 `/healthz`、就绪 `/readyz`；指标：QPS、P95、缓存命中、DB 慢查询。
* 链路追踪：trace\_id 透传至 audit/change\_log 与错误响应。
* 日志规范：结构化 JSON，等级分明；敏感字段脱敏。

### 6.8 迁移与扩展

* MVP 可先以单仓库多服务（monorepo）与共享 SDK；后续独立仓库与独立发布。
* 若未来新增“文件服务”“账单服务”“课程服务”，沿用相同事件总线与鉴权模型。

---

首选在网关/Ingress 层做统一前缀 & 重写，同时在各 NestJS 服务里设置 globalPrefix = 'core'，这样：

能保证外部一致（/core），

即使绕过网关直连服务，也保持一致的路由约定，

回滚/兼容更容易（老路径 /api/... 可做 301 或透明重写到 /core/... 一段时间）。

