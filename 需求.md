
下面是面向“用户与校区独立微服务”的 **NestJS + TypeScript** 架构文档（说明–原理–讲解），包含：项目名称、技术栈与环境、功能点、数据库设计、API 参数与输出、技术方案（含性能与备份、审计与Redis）。按你的需求覆盖用户、校区与薪资（区间法）全链路，**不含任何代码**。

---

## 1. 项目名称

EduHub Microservices – User & Campus Domain (with Compensation & Payroll)

---

## 2. 框架技术，语言，环境

* 语言/运行时：TypeScript、Node.js 20 LTS（NestJS 10，底层首选 Fastify 以获得更高 QPS）
* 架构范式：微服务 + DDD（领域拆分：user-service、campus-service、payroll-service）
* 通信协议：

  * 公网/网关：HTTP/REST（OpenAPI 3 规范）
  * 内部：gRPC 或消息总线（事件：NATS / Kafka 二选一）
* 数据存储：MySQL 8.0（每个服务**独立数据库**，无跨库外键）、对象存储（身份证电子版文件以 URL/Key 引用）
* 缓存与队列：Redis 7（缓存、分布式锁、限流、会话、延时任务/队列）
* 部署与运维：Docker / Kubernetes、Prometheus + Grafana、ELK/EFK、OpenTelemetry
* 时区与本地化：Asia/Taipei，ISO-8601 日期时间

---

## 3. 功能点

* 用户域（user-service）

  * 用户主数据（增删改查、筛选、状态流转、校区归属、角色关联）
  * 身份证电子版元数据管理（仅保存受控 URL/Key）
  * 审计：用户信息变更留痕
* 校区域（campus-service）

  * 校区主数据（多租户 org 维度）
  * 校区账户/开票资料、教室管理
  * 负责人指派（引用用户ID，服务间校验）
  * 审计：校区与教室变更留痕
* 薪资与发薪（payroll-service）

  * 薪资标准“区间法”管理（\[valid\_from, valid\_to)）
  * 防区间重叠校验、自动闭合上一区间
  * 任意日期点查有效薪资；月度应发按日折算；批量生成当月快照
  * 审计：薪资标准与发薪确认留痕
* 平台级能力

  * Redis 缓存/锁/限流；API 网关鉴权与配额；幂等与请求跟踪
  * 备份与恢复（全量+增量/日志，异地冗余）
  * 多租户隔离与 RBAC、敏感字段脱敏/加密

---

## 4. 数据库设计（MySQL 8，**按服务独立库**，示意字段与约束；不写DDL）

### 4.1 user-service（用户域数据库）

**表：user**

* user\_id (PK, bigint)
* org\_id (bigint, 逻辑多租户)
* campus\_id (bigint，引用 campus-service 的主键值，仅存ID不做跨库外键)
* username (varchar, 唯一)
* employment\_status (enum: 在职/离职/停薪留职)
* hire\_date (date)
* email (varchar, 唯一)
* phone (varchar, 唯一)
* id\_card\_no (varchar, 唯一，敏感)
* id\_card\_file (varchar, 存储URL/Key，敏感)
* education (enum: 小学/初中/高中/中专/大专/本科/硕士/博士/其他)
* hukou\_address (varchar)
* current\_address (varchar)
* gender (enum: 男/女/其他/未透露)
* role (varchar，轻量角色，建议与 RBAC 关联表并存)
* age (tinyint, 可冗余；建议另有 birthdate)
* created\_at / updated\_at (timestamp)

索引与约束（示例）

* 唯一：username, email, phone, id\_card\_no
* 组合：org\_id + campus\_id、employment\_status + campus\_id
* 脱敏视图（应用层或只读接口层实现）

**表：role**（可选，推荐）

* role\_id (PK), code (唯一), name

**表：user\_role**（多对多）

* user\_id + role\_id (PK)

**表：audit\_log**（或统一到 change\_log）

* id (PK), org\_id, actor\_user\_id, entity\_type('user'), entity\_id, action(create/update/delete), diff\_json, created\_at, request\_id

---

### 4.2 campus-service（校区域数据库）

**表：org**

* org\_id (PK), name (唯一), code (唯一), remark, created\_at, updated\_at

**表：tax\_profile**

* tax\_profile\_id (PK), name(唯一), rate(decimal%), is\_tax\_included(boolean), created\_at, updated\_at

**表：campus**

* campus\_id (PK)
* org\_id (FK 逻辑)
* name (varchar)
* code (varchar, 唯一)
* type (enum: 直营/加盟/合作)
* status (enum: 筹备/试运营/营业/停业/关闭)
* province / city / district (varchar)
* address (varchar)
* latitude / longitude (decimal)
* principal\_user\_id (bigint，引用 user 的ID，应用层/事件校验)
* phone / email (varchar)
* biz\_hours (json)
* open\_date / close\_date (date)
* area (decimal), capacity (int)
* trade\_area\_tags (json)
* remark (text)
* created\_at / updated\_at (timestamp)

索引

* 唯一：code
* 组合：org\_id + status、org\_id + name

**表：campus\_billing\_profile**

* id (PK)
* campus\_id (bigint)
* invoice\_title / tax\_no (varchar)
* bank\_name / bank\_account (varchar)
* invoice\_address / phone (varchar)
* tax\_profile\_id (bigint)
* created\_at / updated\_at

索引

* campus\_id、tax\_profile\_id

**表：classroom**

* classroom\_id (PK)
* campus\_id (bigint)
* name (varchar)
* code (varchar, 唯一)
* capacity (int)
* course\_type\_tags (json)
* status (enum: 可用/维护/停用)
* created\_at / updated\_at

索引

* 唯一：code
* 组合：campus\_id + status

**表：audit\_log / change\_log**（同规范）

---

### 4.3 payroll-service（薪资与发薪数据库）

**表：user\_compensation**（区间法，核心）

* comp\_id (PK)
* org\_id, user\_id (bigint)
* base\_salary (decimal(12,2))
* perf\_salary (decimal(12,2))
* valid\_from (date, 含)
* valid\_to (date, 不含，可空=至今)
* reason (varchar)
* created\_by (bigint), created\_at (timestamp)

索引与约束

* 唯一：user\_id + valid\_from
* 范围：user\_id + valid\_from + valid\_to（支持点查与月度相交查询）
* 应用层/触发器：同一 user 区间不得重叠

**表：payroll\_run**（发薪快照）

* run\_id (PK)
* org\_id, user\_id (bigint)
* payroll\_month (date，月初)
* period\_start / period\_end (date)
* days\_in\_month (int), days\_covered (int)
* base\_amount / perf\_amount / allowances / deductions (decimal)
* gross\_amount / tax\_amount / net\_amount (decimal)
* status (enum: draft/confirmed/paid)
* snapshot\_json (json)
* created\_at (timestamp)

索引

* 唯一：payroll\_month + user\_id
* 组合：user\_id + payroll\_month

**表：change\_log**（全域通用，建议单独库或平台库）

* id (PK), org\_id
* entity\_type (user/campus/user\_compensation/payroll\_run…)
* entity\_id (bigint)
* field\_name (varchar)
* old\_value (text), new\_value (text)
* changed\_by (bigint), changed\_at (timestamp)
* change\_reason (text), ip\_address, device\_info
* request\_id / trace\_id

---

## 5. API 接口参数和输出（按服务分组；只列**参数与JSON结构**，不含代码）

### 5.1 user-service（路径前缀：/api/users）

通用请求头

* Authorization: Bearer <token>
* X-Request-Id: <uuid>（幂等）
* X-Org-Id: \<org\_id>（多租户）
* X-Campus-Id: \<campus\_id>（可选）

1）创建用户 `POST /`
请求体

```
{
  "org_id": 1,
  "campus_id": 101,
  "username": "zhangsan",
  "employment_status": "在职",
  "hire_date": "2025-08-01",
  "email": "zhangsan@example.com",
  "phone": "+886-912345678",
  "id_card_no": "110101199001011234",
  "id_card_file": "s3://bucket/path/to/idcard.pdf",
  "education": "本科",
  "hukou_address": "北京...",
  "current_address": "北京...",
  "gender": "男",
  "role": "teacher",
  "age": 29
}
```

响应体

```
{
  "user_id": 2001,
  "created_at": "2025-08-16T03:12:00Z"
}
```

2）查询用户 `GET /{user_id}`
响应体

```
{
  "user_id": 2001,
  "org_id": 1,
  "campus_id": 101,
  "username": "zhangsan",
  "employment_status": "在职",
  "hire_date": "2025-08-01",
  "email": "zhangsan@example.com",
  "phone": "+886-912345678",
  "id_card_no": "1101**********1234",
  "id_card_file": "signed-url-or-key",
  "education": "本科",
  "hukou_address": "北京...",
  "current_address": "北京...",
  "gender": "男",
  "roles": ["teacher"],
  "age": 29,
  "created_at": "2025-08-16T03:12:00Z",
  "updated_at": "2025-08-16T03:12:00Z"
}
```

3）分页列表 `GET /?q=&status=&campus_id=&page_size=&cursor=`
响应体

```
{
  "items": [ { ...user summary... } ],
  "next_cursor": "eyJwYWdlIjoyfQ==",
  "total": 1240
}
```

4）更新用户 `PATCH /{user_id}`
请求体（部分字段）

```
{
  "employment_status": "停薪留职",
  "email": "new@example.com",
  "campus_id": 102,
  "role": "finance",
  "change_reason": "内部轮岗"
}
```

响应体

```
{ "updated": true, "updated_at": "2025-08-16T04:10:00Z" }
```

5）删除/停用 `DELETE /{user_id}`
响应体

```
{ "deleted": true }
```

6）审计查询 `GET /{user_id}/changes?from=&to=&page_size=&cursor=`
响应体

```
{
  "items": [
    {
      "changed_at": "2025-08-16T04:10:00Z",
      "changed_by": 9001,
      "field_name": "employment_status",
      "old_value": "在职",
      "new_value": "停薪留职",
      "reason": "内部轮岗",
      "request_id": "..."
    }
  ],
  "next_cursor": null
}
```

---

### 5.2 campus-service（路径前缀：/api/campuses）

1）创建校区 `POST /`
请求体

```
{
  "org_id": 1,
  "name": "海淀校区",
  "code": "HAIDIAN-01",
  "type": "直营",
  "status": "营业",
  "province": "北京",
  "city": "北京",
  "district": "海淀",
  "address": "中关村...",
  "latitude": 39.98,
  "longitude": 116.31,
  "principal_user_id": 2001,
  "phone": "010-12345678",
  "email": "campus@xx.com",
  "biz_hours": {"mon-fri":"09:00-20:00","sat-sun":"09:00-18:00"},
  "open_date": "2024-09-01",
  "area": 350.50,
  "capacity": 120,
  "trade_area_tags": ["地铁10号线","商圈A"],
  "remark": "重点校区"
}
```

响应体

```
{ "campus_id": 101, "created_at": "2025-08-16T03:30:00Z" }
```

2）查询/更新/列表（同用户风格）

3）开票资料 `POST /{campus_id}/billing-profiles`
请求体

```
{
  "invoice_title": "北京某某文化有限公司",
  "tax_no": "9111XXXXXXXXXXXX",
  "bank_name": "中国银行",
  "bank_account": "1234567890",
  "invoice_address": "北京...",
  "phone": "010-88888888",
  "tax_profile_id": 10
}
```

响应体

```
{ "id": 501, "created_at": "2025-08-16T03:40:00Z" }
```

4）教室 `POST /{campus_id}/classrooms`
请求体

```
{
  "name": "A101",
  "code": "A101",
  "capacity": 20,
  "course_type_tags": ["素描","油画"],
  "status": "可用"
}
```

响应体

```
{ "classroom_id": 3001 }
```

5）校区审计 `GET /{campus_id}/changes?from=&to=`

---

### 5.3 payroll-service（路径前缀：/api/payroll）

1）设置薪资标准（自动闭合上一条） `POST /compensations`
请求体

```
{
  "org_id": 1,
  "user_id": 2001,
  "base_salary": 9000.00,
  "perf_salary": 2500.00,
  "valid_from": "2025-07-01",
  "reason": "转正",
  "operator_id": 9001
}
```

响应体

```
{ "comp_id": 70001, "created_at": "2025-08-16T04:00:00Z" }
```

2）查询某日有效薪资 `GET /compensations/effective?user_id=&date=`
响应体

```
{
  "user_id": 2001,
  "date": "2025-07-15",
  "base_salary": 9000.00,
  "perf_salary": 2500.00,
  "source_comp_id": 70001
}
```

3）区间列表 `GET /compensations?user_id=&from=&to=&page_size=&cursor=`

4）计算单人某月应发（不落库） `GET /runs/preview?user_id=&month=2025-07-01`
响应体

```
{
  "user_id": 2001,
  "month": "2025-07-01",
  "days_in_month": 31,
  "days_covered": 31,
  "base_amount": 8854.84,
  "perf_amount": 2467.74
}
```

5）生成当月快照（单人）`POST /runs/generate`
请求体

```
{
  "org_id": 1,
  "user_id": 2001,
  "month": "2025-07-01",
  "allowances": 0,
  "deductions": 0
}
```

响应体

```
{ "run_id": 81001, "status": "draft" }
```

6）批量生成当月快照（在职）`POST /runs/generate-batch`
请求体

```
{ "org_id": 1, "month": "2025-07-01", "filter": { "campus_ids": [101,102] } }
```

响应体

```
{ "submitted": true, "batch_id": "run-2025-07-org1", "estimated": 234 }
```

7）确认或支付 `PATCH /runs/{run_id}`
请求体

```
{ "action": "confirm" }
```

响应体

```
{ "run_id": 81001, "status": "confirmed" }
```

8）发薪审计 `GET /runs/{run_id}/changes`

---

### 5.4 通用错误与分页

错误响应

```
{
  "error": {
    "code": "VALIDATION_ERROR",
    "message": "phone already exists",
    "details": {"field": "phone"},
    "request_id": "..."
  }
}
```

分页（游标）

```
{
  "items": [ ... ],
  "next_cursor": "base64-opaque",
  "total": 1234
}
```

---

## 6. 技术方案（原理与性能要点）

### 6.1 领域与边界

* **user-service** 独占用户主数据与角色；不对外暴露 PII 原始值（身份证号、文件URL仅在授权后返回带签名的短时效链接或做掩码）。
* **campus-service** 独占校区与教室；对 `principal_user_id` 仅存**外部ID**，通过内部 gRPC/事件与 user-service 校验一致性（**应用级外键**）。
* **payroll-service** 独占薪资与发薪；基于“区间法”高效点查与月度计算；产出**不可变快照**。

### 6.2 数据一致性与事件

* **Outbox + 事件总线**：每次主数据变更写入本地 outbox 并可靠投递（用户创建/更新、校区负责人变更、薪资标准变更、快照确认等）。
* **最终一致**：跨域引用采用**异步校验/补偿**（SAGA / 反查/回滚）。

### 6.3 Redis 接入角色

* **缓存**：用户概要、校区基础信息、薪资“某日有效值”与“月度计算结果”缓存（TTL 15–30 分钟；快照确认后可延长）。
* **分布式锁**：以 `lock:compensation:user:{user_id}` 防止并发写入导致区间重叠；批量发薪 `lock:payroll:month:{org_id}:{month}`。
* **限流与幂等**：请求级 Token 桶（/generate-batch）、`X-Request-Id` 去重。
* **队列**：批量发薪生成、审计落库、缓存失效等异步任务（Redis Streams/List 或接入专用 MQ）。

### 6.4 性能与可扩展

* **Fastify + Keep-Alive + HTTP压缩**；启用连接池复用。
* **读写分离**：MySQL 主写从读；报表/批量计算走只读副本。
* **索引策略**：

  * user：username/email/phone/id\_card\_no 唯一，(org\_id,campus\_id,status) 组合
  * campus：code 唯一，(org\_id,status)
  * compensation： (user\_id, valid\_from, valid\_to) 范围索引覆盖金额列
  * payroll\_run： (payroll\_month,user\_id) 唯一
* **批量计算优化**：月度计算按“相交区间”聚合，避免逐日迭代；对热门月份结果物化至 Redis。
* **分页**：游标分页优先，减少深翻页代价。
* **灰度与回滚**：配置开关控制新规则启用；事件消费实现幂等与重试。

### 6.5 安全与合规

* **RBAC**：平台级角色 + 资源范围（org/campus 维度）。薪资与身份证仅 HR/财务可见。
* **PII**：身份证号存加密或哈希，接口默认返回掩码；身份证文件只返回短时签名URL（或仅返回 Key 需再换签）。
* **传输与存储**：TLS；数据库磁盘加密；对象存储 KMS。
* **审计**：统一 change\_log；关键动作（作废、确认、支付）二次确认 + 审批链（可留扩展字段）。

### 6.6 备份与恢复（全域）

* **策略（Asia/Taipei）**

  * 日全量：每日 03:00
  * 增量/日志（binlog/WAL）：每 5–15 分钟
  * 保留：binlog 14 天；日全量 14 天；周全量 8 周；月全量 12 个月
  * 关键操作（DDL/大批导入/结算）：前后各一次快照
  * 异地副本 + 3-2-1 法则
* **演练**：季度 PITR 恢复演习；快照校验（checksum + 试恢复）
* **文件对象**：对象存储启用版本化与生命周期（≥90天转低频/归档）

### 6.7 可观测性与运维

* 健康检查 `/healthz`、就绪 `/readyz`；指标：QPS、P95、缓存命中、DB 慢查询。
* 链路追踪：trace\_id 透传至 audit/change\_log 与错误响应。
* 日志规范：结构化 JSON，等级分明；敏感字段脱敏。

### 6.8 迁移与扩展

* MVP 可先以单仓库多服务（monorepo）与共享 SDK；后续独立仓库与独立发布。
* 若未来新增“文件服务”“账单服务”“课程服务”，沿用相同事件总线与鉴权模型。

---

首选在网关/Ingress 层做统一前缀 & 重写，同时在各 NestJS 服务里设置 globalPrefix = 'core'，这样：

能保证外部一致（/core），

即使绕过网关直连服务，也保持一致的路由约定，

回滚/兼容更容易（老路径 /api/... 可做 301 或透明重写到 /core/... 一段时间）。






# 账单服务（billing-service）需求与API文档

## 0. 定位与边界

* **职责**：为每个校区维护独立账本，记录**入账/出账**明细，支持从“原始文本(originalText)”快速记账；支持**按年/月/日**、**teacher/recorder/reporter**维度的检索与统计；支持与**用户服务(user-service)**、**校区服务(campus-service)** 进行用户与校区的存在性/权限校验；与**薪资/分润**无强耦合，但提供“老师分成（teacher share）”结构，为后续结算对接提供依据。
* **与现有服务关系**：

  * 读取 user/campus 概要信息（HTTP 内部调用 + 失败降级）。
  * 不跨库外键，仅保存外部ID与冗余展示名。
* **统一规范**：

  * 鉴权：`Authorization: Bearer <token>`
  * 多租户：`X-Org-Id`；校区：`X-Campus-Id`
  * 幂等：`X-Request-Id`（请求去重）
  * 时区：Asia/Taipei（与现有工程统一）
  * 审计：关键操作写入 `ledger_audit`，透传 `trace_id/request_id`

---

## 1. 角色与权限（RBAC + 数据域约束）

### 角色定义

* **super\_admin（超级管理员）**：全组织/全校区可见，可做一切操作。
* **principal（校长）**：仅可见**自己负责或绑定的校区**数据；可管理本校区账本与账单。
* **manager/finance（财务/运营）**（可选）：与 principal 权限相近，但不一定能改类目；按需细分。
* **teacher（老师）**：仅可见**与自己有关**的账单（作为 `teacher_shares` 参与者或 `reporter`）。
* **auditor（审计/只读）**（可选）：只读访问授权范围内数据。

### 数据域约束（服务层强制）

* 所有查询与写入**默认附带**：`org_id = X-Org-Id`。
* 可见范围：

  * super\_admin：全部 campus
  * principal/finance/manager：`campus_id ∈ 用户授权列表`
  * teacher：`entry.teacher_shares 包含自己` 或 `reporter_user_id = 自己`
* 写入范围：

  * super\_admin：任意校区
  * principal/finance/manager：仅本校区
  * teacher：默认**无写入权限**（可选开关：允许创建“新签线索/续费记录草稿”）

---

## 2. 数据库设计（billing\_service）

> 说明：不跨库外键；全部 `*_name` 属于冗余展示字段，避免跨服务渲染频繁调用。金额以**正数**存储，由 `type` 决定收/支符号。

### 2.1 账本（每校区至少1个）

**表：`ledger_book`**

* `book_id` (PK, bigint)
* `org_id` (bigint, not null)
* `campus_id` (bigint, not null)
* `name` (varchar) 例：“回龙观校区账本”
* `code` (varchar, unique) 可选
* `currency` (char(3)) 默认 `CNY`
* `status` (enum: active/archived) 默认 active
* `created_at` / `updated_at` (timestamp)

**索引**：(`org_id`, `campus_id`, `status`)

### 2.2 类目

**表：`ledger_category`**

* `category_id` (PK, bigint)
* `org_id` (bigint)
* `type` (enum: `income` / `expense`)
* `code` (varchar, unique per org+type) 例：`rent`/`new_signup`/`renewal`
* `name` (varchar) 例：`房租`/`新签`/`续费`
* `is_teacher_related` (bool) 对老师分成是否有意义（如 `new_signup`/`renewal` 为 true）
* `is_active` (bool) 默认 true
* `created_at` / `updated_at`

**索引**：(`org_id`, `type`, `is_active`)

### 2.3 账单明细

**表：`ledger_entry`**

* `entry_id` (PK, char(26)) 建议 **ULID**，与示例ID风格相近
* `book_id` (bigint)
* `org_id` / `campus_id` (bigint)
* `type` (enum: `income` / `expense`)
* `category_code` (varchar)（与 `ledger_category.code` 对齐）
* `category_name` (varchar)
* `amount` (decimal(12,2)) 金额；正数
* `occurred_at` (datetime) 来自 `time` 字段（例：`2025-06-16 15:12`）
* `original_text` (text)
* `reporter_user_id` (bigint, nullable) 业务用户ID（可空）
* `reporter_name` (varchar) 例：“老板”“崔晓燕”
* `recorder_user_id` (bigint, nullable) 记账人
* `recorder_name` (varchar) 例：“系统”“张三”
* `status` (enum: `normal`/`voided`/`draft`) 默认 `normal`
* `attachments_count` (int) 冗余
* `created_by` (bigint) 操作人
* `created_at` / `updated_at` (timestamp)
* `request_id` (varchar) 幂等去重

**关键索引**：

* (`org_id`,`campus_id`,`occurred_at`)
* (`org_id`,`campus_id`,`type`,`category_code`,`occurred_at`)
* (`org_id`,`reporter_name`,`occurred_at`)
* (`org_id`,`recorder_name`,`occurred_at`)

### 2.4 老师分成（可选）

**表：`ledger_entry_teacher_share`**

* `id` (PK, bigint)
* `entry_id` (char(26), FK逻辑)
* `teacher_user_id` (bigint, nullable)
* `teacher_name` (varchar)
* `ratio` (decimal(5,4)) \[0,1]
* `money` (decimal(12,2)) 可能为0，或由 `amount * ratio` 计算/回填
* `created_at`

**索引**：(`entry_id`), (`teacher_name`), (`teacher_user_id`,`entry_id`)

> 规则：仅 `type=income` 且 `is_teacher_related=true` 的类目允许填写分成；`Σ ratio ≤ 1.0`。

### 2.5 附件（可选）

**表：`ledger_attachment`**

* `id` (PK, bigint)
* `entry_id` (char(26))
* `object_key` (varchar)（或URL）
* `mime_type` (varchar)
* `created_at`

### 2.6 审计

**表：`ledger_audit`**

* `id` (PK, bigint)
* `org_id` / `campus_id`
* `entity_type` (enum: `book`/`entry`/`category`)
* `entity_id` (varchar)
* `action` (enum: `create`/`update`/`void`/`delete`)
* `diff_json` (json)
* `actor_user_id` (bigint)
* `request_id` (varchar)
* `created_at` (timestamp)

---

## 3. 业务规则与校验

1. **来源解析**：`originalText` 可选；`time` 必填并解析为 `occurred_at`；若未传 `amount`，`expense` 必须提供 `amount`；`income` 建议提供 `amount`（否则仅记录事件与老师分成占比，money=0）。
2. **分成**（income 且 `is_teacher_related` 类目）：

   * `ratio` 范围 \[0,1]，通常 0.1–0.5 之间由业务约束；
   * `Σ ratio ≤ 1.0`；`money` = `round(amount * ratio, 2)`（若调用端传了 money，以服务侧规则为准可重算或校验允许误差±0.01）。
3. **状态**：

   * `normal`：有效
   * `voided`：作废（保留记录，不计入统计）
   * `draft`：草稿（不入统计，可编辑）
4. **金额口径**：报表处统一按 `type` 映射符号：

   * `income` 计入正数；`expense` 计入负数；汇总 `sum(income) - sum(expense)`。
5. **权限**：

   * 创建/编辑/作废：super\_admin、principal、finance（限本校区）
   * 老师只能查与己相关项（可选：允许创建 draft）
6. **幂等**：同一 `X-Request-Id` 在TTL内重复请求直接返回首次结果。
7. **审计**：所有增删改写审计，关键信息入 `ledger_audit`。

---

## 4. API 文档（路径前缀建议统一 `/core/billing`）

> 公共请求头
>
> * `Authorization: Bearer <token>`
> * `X-Org-Id: <org_id>`
> * `X-Campus-Id: <campus_id>`（列表页可选；super\_admin 可跨校区）
> * `X-Request-Id: <uuid>`（建议用于创建/更新幂等）

### 4.1 账本（Book）

#### 4.1.1 创建账本

`POST /core/billing/books`

**请求体**

```json
{
  "campus_id": 10201,
  "name": "回龙观校区账本",
  "code": "CAMPUS-10201-BOOK01",
  "currency": "CNY"
}
```

**响应**

```json
{ "book_id": 50001, "created_at": "2025-06-20T07:12:00Z" }
```

#### 4.1.2 查询账本列表

`GET /core/billing/books?campus_id=&status=&q=&page_size=&cursor=`

**响应**

```json
{
  "items": [
    { "book_id": 50001, "campus_id": 10201, "name": "回龙观校区账本", "status": "active" }
  ],
  "next_cursor": null,
  "total": 1
}
```

### 4.2 类目（Category）

#### 4.2.1 创建/更新类目

`POST /core/billing/categories`（创建）
`PATCH /core/billing/categories/{category_id}`（更新）

**请求体**

```json
{
  "type": "expense",
  "code": "rent",
  "name": "房租",
  "is_teacher_related": false
}
```

**响应**

```json
{ "category_id": 30001, "created_at": "2025-06-20T07:12:00Z" }
```

#### 4.2.2 列表

`GET /core/billing/categories?type=&is_active=&q=`

**响应（示例）**

```json
{
  "items": [
    { "category_id": 30001, "type": "expense", "code": "rent", "name": "房租", "is_teacher_related": false },
    { "category_id": 30002, "type": "income", "code": "new_signup", "name": "新签", "is_teacher_related": true },
    { "category_id": 30003, "type": "income", "code": "renewal", "name": "续费", "is_teacher_related": true }
  ],
  "total": 3
}
```

### 4.3 记账（Entry）

> 入参与你的样例完全兼容；服务侧会用 token / headers 识别 org/campus/用户，并写入对应账本。

#### 4.3.1 创建记账

`POST /core/billing/entries`

**请求体（支持批量或单条；以下为单条，兼容你的样例字段）**

```json
{
  "id": "175040357882335yclmtdq",
  "type": "expense",
  "category": "rent",
  "categoryName": "房租",
  "amount": 3000,
  "originalText": "2025.6.16出账房租3000元",
  "time": "2025.06.16 15:12",
  "reporter": "老板",
  "recorder": "系统",
  "attachments": []
}
```

**示例：income 新签（含老师分成）**

```json
{
  "id": "1750403578840il1xvqoqd",
  "type": "income",
  "category": "new_signup",
  "categoryName": "新签",
  "amount": 12000,
  "originalText": "2025.6.17新签学员，崔晓燕老师负责",
  "time": "2025.06.17 15:12",
  "reporter": "崔晓燕",
  "recorder": "系统",
  "teacher": [
    { "name": "崔晓燕", "ratio": 0.2, "money": 0 }
  ]
}
```

**响应**

```json
{
  "entry_id": "1750403578840il1xvqoqd",
  "status": "normal",
  "created_at": "2025-06-20T07:12:00Z"
}
```

> 说明
>
> * `category` → `category_code`；`categoryName` → `category_name`
> * `teacher` 数组用于 teacher\_shares 写入；服务将依据 `amount` 回算 `money`
> * 若提交 `money` 与计算不一致，默认以服务重算覆盖（可开关容忍±0.01）

#### 4.3.2 批量创建

`POST /core/billing/entries:batch`

* 接收数组；逐条幂等；返回成功/失败列表与 request\_id 对应映射。

#### 4.3.3 更新（仅 `draft/normal` 可改）

`PATCH /core/billing/entries/{entry_id}`

* 支持变更 `category`/`amount`/`occurred_at`/`teacher_shares`/`status(draft→normal)`

#### 4.3.4 作废

`POST /core/billing/entries/{entry_id}:void`
**响应**：`{ "entry_id": "...", "status": "voided" }`

#### 4.3.5 详情

`GET /core/billing/entries/{entry_id}`
**响应（摘要）**

```json
{
  "entry_id": "1750403578840il1xvqoqd",
  "org_id": 1,
  "campus_id": 10201,
  "type": "income",
  "category_code": "new_signup",
  "category_name": "新签",
  "amount": 12000,
  "occurred_at": "2025-06-17 15:12:00",
  "reporter_name": "崔晓燕",
  "recorder_name": "系统",
  "teacher_shares": [
    { "teacher_name": "崔晓燕", "ratio": 0.2, "money": 2400.00 }
  ],
  "status": "normal",
  "attachments_count": 0
}
```

#### 4.3.6 列表与检索

`GET /core/billing/entries?from=2025-06-01&to=2025-06-30&type=income&category=new_signup&teacher=崔晓燕&reporter=崔晓燕&recorder=系统&campus_id=10201&page_size=50&cursor=`

* 支持筛选：

  * `from/to`（按 `occurred_at` 闭区间）
  * `type`、`category`
  * `teacher`（按 name 或 `teacher_user_id`）
  * `reporter`、`recorder`（name）
  * `campus_id`（super\_admin 可跨校区）
  * `status`（默认 `normal`）
* 返回游标分页与 `total`（可配置是否估算）

**响应（示例）**

```json
{
  "items": [
    {
      "entry_id": "1750403578840il1xvqoqd",
      "type": "income",
      "category_code": "new_signup",
      "category_name": "新签",
      "amount": 12000,
      "occurred_at": "2025-06-17 15:12:00",
      "reporter_name": "崔晓燕",
      "recorder_name": "系统",
      "teacher_shares": [{ "teacher_name": "崔晓燕", "ratio": 0.2, "money": 2400 }]
    }
  ],
  "next_cursor": null,
  "total": 1
}
```

### 4.4 报表与统计

#### 4.4.1 概览（按日/月汇总）

`GET /core/billing/reports/summary?from=2025-06-01&to=2025-06-30&campus_id=10201&group_by=day|month`

**响应**

```json
{
  "currency": "CNY",
  "period": { "from": "2025-06-01", "to": "2025-06-30" },
  "group_by": "day",
  "items": [
    { "date": "2025-06-16", "income": 0.00, "expense": 3000.00, "net": -3000.00 },
    { "date": "2025-06-17", "income": 12000.00, "expense": 0.00, "net": 12000.00 },
    { "date": "2025-06-28", "income": 8000.00, "expense": 0.00, "net": 8000.00 }
  ],
  "totals": { "income": 20000.00, "expense": 3000.00, "net": 17000.00 }
}
```

#### 4.4.2 老师分成（月度）

`GET /core/billing/reports/teacher-shares?month=2025-06-01&campus_id=10201&teacher=崔晓燕`

**响应**

```json
{
  "month": "2025-06-01",
  "items": [
    { "teacher_name": "崔晓燕", "entries": 2, "amount_total": 20000.00, "share_total": 4000.00 }
  ],
  "totals": { "amount_total": 20000.00, "share_total": 4000.00 }
}
```

> 说明：仅统计 `type=income & status=normal & is_teacher_related=true`。

#### 4.4.3 类目分析

`GET /core/billing/reports/by-category?from=&to=&type=&campus_id=`

**响应**

```json
{
  "items": [
    { "category_code": "rent", "category_name": "房租", "count": 1, "amount": 3000.00, "sign": -1 },
    { "category_code": "new_signup", "category_name": "新签", "count": 1, "amount": 12000.00, "sign": +1 }
  ]
}
```

### 4.5 导出（可选）

`POST /core/billing/exports/entries`

* 参数同列表；返回导出任务ID，完成后生成文件Key（CSV/XLSX），供文件服务签名下载。

---

## 5. 服务间调用与数据一致性

* **用户/校区校验**：创建与查询时可用内部HTTP客户端校验 `principal_user_id` 与 `campus_id` 的存在性/授权性（失败可降级仅依赖 token 的 org/campus 声明）。
* **事件**（可选）：创建/作废账单发布事件 `billing.entry.created/voided`，供后续风控/看板订阅。
* **缓存与锁**：

  * 列表/报表查询结果可缓存短TTL（15–30min）。
  * 批量创建时对同一 `entry_id` 使用分布式锁，防重复落库（与 `X-Request-Id` 互补）。

---

## 6. 错误与返回格式

**错误响应**

```json
{
  "error": {
    "code": "VALIDATION_ERROR",
    "message": "teacher shares ratio sum exceeds 1.0",
    "details": { "sum": 1.2 },
    "request_id": "..."
  }
}
```

**常见错误码**

* `AUTH_REQUIRED` / `FORBIDDEN`（越权）
* `NOT_FOUND`（账本/账单不存在或无权限）
* `VALIDATION_ERROR`（必填、范围、类目/类型不匹配）
* `IDEMPOTENT_REPLAY`（重复请求）
* `CONFLICT`（并发写入冲突）

---

## 7. 前端页面与字段建议（Vue3 + TS + Vite + Pinia）

### 7.1 账单列表页

* **筛选**：日期(支持日历与快速区间)、收支类型、类目、老师、reporter、recorder、校区（仅授权范围）、状态
* **表格列**：日期、类型、类目、金额（正负色）、reporter、recorder、老师分成（展开显示姓名/占比/金额）、备注/原文、附件数、状态、操作
* **批量操作**：批量作废 / 批量导出
* **权限**：老师登录仅显示与己有关数据（列项简化）

### 7.2 新增/编辑抽屉

* 基本信息：日期、类型、类目、金额、reporter、recorder、原始文本
* 老师分成：动态行（姓名/占比/金额，自动回算）
* 附件上传：走文件服务签名上传
* 保存：`draft` / `normal` 两种按钮（权限与校验不同）

### 7.3 报表页

* 日/月趋势图（收入、支出、净额）
* 老师分成排行（Top N）
* 类目占比（饼/条）
* 导出按钮

---

## 8. 对你给的样例数据的映射说明

### 样例1（房租支出）

```json
{
  "id": "175040357882335yclmtdq",
  "type": "expense",
  "category": "rent",
  "categoryName": "房租",
  "originalText": "2025.6.16出账房租3000元",
  "time": "2025.06.16 15:12",
  "reporter": "老板",
  "recorder": "系统",
  "createdAt": "2025.06.20 15:12"
}
```

* **落库**：`ledger_entry`

  * `entry_id=id`、`type=expense`、`category_code=rent`、`category_name=房租`
  * `occurred_at=2025-06-16 15:12:00`、`reporter_name=老板`、`recorder_name=系统`
  * **需要金额**：建议调用端补传 `amount: 3000`（若不传，服务层可尝试从 originalText 解析，解析失败则校验报错）

### 样例2（新签收入 + 老师分成）

```json
{
  "id": "1750403578840il1xvqoqd",
  "type": "income",
  "category": "new_signup",
  "categoryName": "新签",
  "originalText": "2025.6.17新签学员，崔晓燕老师负责",
  "time": "2025.06.17 15:12",
  "reporter": "崔晓燕",
  "recorder": "系统",
  "createdAt": "2025.06.20 15:12",
  "teacher": [{ "name":"崔晓燕","ratio":0.2,"money":0 }]
}
```

* **落库**：`ledger_entry` + `ledger_entry_teacher_share`
* 若 `amount` 一并传入（建议传），则会计算 `money = amount * 0.2`；若不传，money 保持0，后续补齐金额时可重算。

### 样例3（续费收入 + 老师分成）

```json
{
  "id": "1750403677508vj5cy8v0r",
  "type": "income",
  "category": "renewal",
  "categoryName": "续费",
  "originalText": "2025.6.28续费学员小红，邬圳宇老师跟进",
  "time": "2025.06.28 15:14",
  "reporter": "邬圳宇",
  "recorder": "系统",
  "createdAt": "2025.06.20 15:14",
  "teacher": [{ "name":"崔晓燕","ratio":0.2,"money":0 }]
}
```

* 同上；`category_code=renewal`；`is_teacher_related=true` → 可录分成。

---

## 9. 落地实现要点（与现有工程一致）

* **框架/引擎**：NestJS 10 + Fastify
* **鉴权**：JWT（统一中间件/Guard）+ 角色/资源守卫（org/campus 级）
* **幂等**：全局拦截器读取 `X-Request-Id`，Redis 记录结果TTL
* **缓存**：查询/报表结果短TTL缓存；作废/更新后失效相关Key
* **索引**：已在表设计中给出，按查询维度覆盖
* **审计**：统一审计服务/装饰器收集变更Diff + `trace_id`
* **时间**：全部以 Asia/Taipei 存储/展示，输入解析允许 `YYYY.MM.DD HH:mm` 与 `YYYY-MM-DD HH:mm:ss`

---

## 10. 对接与迁移

* **类目初始化**：系统预置 `rent/new_signup/renewal` 等；支持后续扩展
* **历史数据导入**：提供 CSV 模板 → `entries:batch` 接口
* **互操作**：后续若做“老师分润结算/工资单挂靠”，可按 `teacher_shares` 汇总推送到 payroll 派生表或临时对账表

---

